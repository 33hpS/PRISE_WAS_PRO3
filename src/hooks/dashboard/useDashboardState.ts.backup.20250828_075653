/**
 * @file hooks/useDashboardState.ts
 * @description Ð¥ÑƒÐº ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÐµÐ¼ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð° Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹
 */

import { useState, useCallback, useReducer, useMemo } from 'react'
import { DashboardState, DashboardAction, DashboardTab, DashboardStats } from '../../types/dashboard/types'
import { DashboardStorage } from '../../services/dashboard/storage'

// ===========================
# ðŸŽ¯ ÐÐÐ§ÐÐ›Ð¬ÐÐžÐ• Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð•
# ===========================

const INITIAL_STATE: DashboardState = {
  activeTab: 'overview',
  stats: { materials: 0, products: 0, collections: 0, priceLists: 0 },
  statsLoading: true,
  user: null,
  loading: true,
  error: null
} as const

// ===========================
# ðŸ”„ REDUCER Ð”Ð›Ð¯ Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð¯
# ===========================

const dashboardReducer = (state: DashboardState, action: DashboardAction): DashboardState => {
  switch (action.type) {
    case 'SET_LOADING':
      return { ...state, loading: action.payload }
    
    case 'SET_USER':
      return { ...state, user: action.payload, loading: false }
    
    case 'SET_ACTIVE_TAB':
      // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² localStorage
      DashboardStorage.setActiveTab(action.payload)
      return { ...state, activeTab: action.payload }
    
    case 'SET_STATS':
      return { ...state, stats: { ...action.payload, lastUpdated: new Date() } }
    
    case 'SET_ERROR':
      return { ...state, error: action.payload, loading: false }
    
    case 'SET_STATS_LOADING':
      return { ...state, statsLoading: action.payload }
    
    default:
      return state
  }
}

// ===========================
# ðŸŽ£ ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ Ð¥Ð£Ðš Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð¯
# ===========================

export const useDashboardState = () => {
  const [state, dispatch] = useReducer(dashboardReducer, INITIAL_STATE)

  // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
  const initializeState = useCallback(() => {
    // Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð½ÑƒÑŽ Ð²ÐºÐ»Ð°Ð´ÐºÑƒ
    const savedTab = DashboardStorage.getActiveTab()
    if (savedTab) {
      dispatch({ type: 'SET_ACTIVE_TAB', payload: savedTab })
    }

    // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    const testUser = DashboardStorage.getTestUser()
    const supabaseUser = DashboardStorage.getSupabaseUser()
    
    const user = testUser || supabaseUser
    if (user) {
      dispatch({ type: 'SET_USER', payload: user })
    } else {
      dispatch({ type: 'SET_LOADING', payload: false })
    }
  }, [])

  // Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ
  const actions = useMemo(() => ({
    setLoading: (loading: boolean) => dispatch({ type: 'SET_LOADING', payload: loading }),
    setUser: (user: DashboardState['user']) => dispatch({ type: 'SET_USER', payload: user }),
    setActiveTab: (tab: DashboardTab) => dispatch({ type: 'SET_ACTIVE_TAB', payload: tab }),
    setStats: (stats: DashboardStats) => dispatch({ type: 'SET_STATS', payload: stats }),
    setError: (error: string | null) => dispatch({ type: 'SET_ERROR', payload: error }),
    setStatsLoading: (loading: boolean) => dispatch({ type: 'SET_STATS_LOADING', payload: loading }),
    initializeState
  }), [initializeState])

  return { state, actions }
}

// ===========================
# ðŸŽ£ Ð¥Ð£Ðš Ð”Ð›Ð¯ Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ˜
# ===========================

export const useDashboardStats = () => {
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const loadStats = useCallback(async (): Promise<DashboardStats> => {
    try {
      setLoading(true)
      setError(null)

      // ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐºÐµÑˆ
      const cached = DashboardStorage.getCachedStats()
      if (cached && DashboardStorage.isCacheValid(cached)) {
        setLoading(false)
        return cached.data
      }

      // Ð˜Ð¼Ð¸Ñ‚Ð°Ñ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
      await new Promise(resolve => setTimeout(resolve, 1000))

      const stats: DashboardStats = {
        materials: 1248,
        products: 342,
        collections: 28,
        priceLists: 156,
        lastUpdated: new Date()
      }

      // ÐšÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ð½Ð° 5 Ð¼Ð¸Ð½ÑƒÑ‚
      DashboardStorage.setCachedStats(stats, 300000)
      
      setLoading(false)
      return stats
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸'
      setError(errorMessage)
      setLoading(false)
      throw err
    }
  }, [])

  const refreshStats = useCallback(() => {
    return loadStats()
  }, [loadStats])

  return { loading, error, loadStats, refreshStats }
}

// ===========================
# ðŸŽ£ Ð¥Ð£Ðš Ð”Ð›Ð¯ ÐŸÐ ÐžÐ˜Ð—Ð’ÐžÐ”Ð˜Ð¢Ð•Ð›Ð¬ÐÐžÐ¡Ð¢Ð˜
# ===========================

export const usePerformanceMetrics = () => {
  const [metrics, setMetrics] = useState({
    loadTime: 0,
    tabSwitchTime: 0,
    lastUpdate: new Date(),
    memoryUsage: 0
  })

  const startTimer = useCallback(() => {
    return performance.now()
  }, [])

  const endTimer = useCallback((startTime: number, operation: string) => {
    const duration = performance.now() - startTime
    
    setMetrics(prev => ({
      ...prev,
      [operation === 'load' ? 'loadTime' : 'tabSwitchTime']: duration,
      lastUpdate: new Date(),
      memoryUsage: (performance as any).memory?.usedJSHeapSize || 0
    }))

    console.log(`âš¡ ${operation}: ${duration.toFixed(2)}ms`)
    return duration
  }, [])

  const logMetrics = useCallback(() => {
    console.group('ðŸ“Š Dashboard Performance Metrics')
    console.log('Load Time:', `${metrics.loadTime.toFixed(2)}ms`)
    console.log('Tab Switch Time:', `${metrics.tabSwitchTime.toFixed(2)}ms`)
    console.log('Memory Usage:', `${(metrics.memoryUsage / 1024 / 1024).toFixed(2)}MB`)
    console.log('Last Update:', metrics.lastUpdate.toISOString())
    console.groupEnd()
  }, [metrics])

  return { metrics, startTimer, endTimer, logMetrics }
}
